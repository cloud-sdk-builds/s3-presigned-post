var e=function(){return e=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var i in r=arguments[t])Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i]);return e},e.apply(this,arguments)};function r(e,r,t,n){return new(t||(t=Promise))(function(i,o){function a(e){try{c(n.next(e))}catch(e){o(e)}}function s(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var r;e.done?i(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(a,s)}c((n=n.apply(e,r||[])).next())})}function t(e,r){var t,n,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=s(0),a.throw=s(1),a.return=s(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(s){return function(c){return function(s){if(t)throw new TypeError("Generator is already executing.");for(;a&&(a=0,s[0]&&(o=0)),o;)try{if(t=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,n=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=r.call(e,o)}catch(e){s=[6,e],n=0}finally{t=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}}function n(e){var r="function"==typeof Symbol&&Symbol.iterator,t=r&&e[r],n=0;if(t)return t.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(r?"Object is not iterable.":"Symbol.iterator is not defined.")}function i(e,r){var t="function"==typeof Symbol&&e[Symbol.iterator];if(!t)return e;var n,i,o=t.call(e),a=[];try{for(;(void 0===r||r-- >0)&&!(n=o.next()).done;)a.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(t=o.return)&&t.call(o)}finally{if(i)throw i.error}}return a}function o(e,r,t){if(t||2===arguments.length)for(var n,i=0,o=r.length;i<o;i++)!n&&i in r||(n||(n=Array.prototype.slice.call(r,0,i)),n[i]=r[i]);return e.concat(n||Array.prototype.slice.call(r))}Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;for(var a={},s={},c=0;c<256;c++){var u=c.toString(16).toLowerCase();1===u.length&&(u="0"+u),a[c]=u,s[u]=c}function l(e){for(var r="",t=0;t<e.byteLength;t++)r+=a[e[t]];return r}var f="X-Amz-Date",h="X-Amz-Signature",d="X-Amz-Security-Token",y="authorization",v=f.toLowerCase(),p=[y,v,"date"],g=h.toLowerCase(),b="x-amz-content-sha256",w=d.toLowerCase(),S={authorization:!0,"cache-control":!0,connection:!0,expect:!0,from:!0,"keep-alive":!0,"max-forwards":!0,pragma:!0,referer:!0,te:!0,trailer:!0,"transfer-encoding":!0,upgrade:!0,"user-agent":!0,"x-amzn-trace-id":!0},m=/^proxy-/,A=/^sec-/,x="AWS4-HMAC-SHA256",O="AWS4-HMAC-SHA256-PAYLOAD",k="aws4_request",j={},C=[];function D(e,r,t){return e+"/"+r+"/"+t+"/"+k}var P=function(e,i,o,a,s){return r(void 0,void 0,void 0,function(){var r,c,u,f,h,d,y,v,p;return t(this,function(t){switch(t.label){case 0:return[4,q(e,i.secretAccessKey,i.accessKeyId)];case 1:if(r=t.sent(),(c=o+":"+a+":"+s+":"+l(r)+":"+i.sessionToken)in j)return[2,j[c]];for(C.push(c);C.length>50;)delete j[C.shift()];u="AWS4"+i.secretAccessKey,t.label=2;case 2:t.trys.push([2,7,8,9]),f=n([o,a,s,k]),h=f.next(),t.label=3;case 3:return h.done?[3,6]:(d=h.value,[4,q(e,u,d)]);case 4:u=t.sent(),t.label=5;case 5:return h=f.next(),[3,3];case 6:return[3,9];case 7:return y=t.sent(),v={error:y},[3,9];case 8:try{h&&!h.done&&(p=f.return)&&p.call(f)}finally{if(v)throw v.error}return[7];case 9:return[2,j[c]=u]}})})};function q(e,r,t){var n=new e(r);return n.update(t),n.digest()}function z(e,r,t){var i,o,a=e.headers,s={};try{for(var c=n(Object.keys(a).sort()),u=c.next();!u.done;u=c.next()){var l=u.value,f=l.toLowerCase();(f in S||(null==r?void 0:r.has(f))||m.test(f)||A.test(f))&&(!t||t&&!t.has(f))||(s[f]=a[l].trim().replace(/\s+/g," "))}}catch(e){i={error:e}}finally{try{u&&!u.done&&(o=c.return)&&o.call(c)}finally{if(i)throw i.error}}return s}var E=function(e){return encodeURIComponent(e).replace(/[!'()*]/g,H)},H=function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()};function L(e,i){var o=e.headers,a=e.body;return r(this,void 0,void 0,function(){var e,r,s,c,u,f,h;return t(this,function(t){switch(t.label){case 0:try{for(e=n(Object.keys(o)),r=e.next();!r.done;r=e.next())if((s=r.value).toLowerCase()===b)return[2,o[s]]}catch(e){f={error:e}}finally{try{r&&!r.done&&(h=e.return)&&h.call(e)}finally{if(f)throw f.error}}return null!=a?[3,1]:[2,"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"];case 1:return"string"==typeof a||ArrayBuffer.isView(a)||(d=a,"function"==typeof ArrayBuffer&&d instanceof ArrayBuffer||"[object ArrayBuffer]"===Object.prototype.toString.call(d))?((c=new i).update(a),u=l,[4,c.digest()]):[3,3];case 2:return[2,u.apply(void 0,[t.sent()])];case 3:return[2,"UNSIGNED-PAYLOAD"]}var d})})}function I(r){var t=r.headers,n=r.query,i=function(e,r){var t={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&r.indexOf(n)<0&&(t[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)r.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(t[n[i]]=e[n[i]])}return t}(r,["headers","query"]);return e(e({},i),{headers:e({},t),query:n?R(n):void 0})}function R(r){return Object.keys(r).reduce(function(t,n){var a,s=r[n];return e(e({},t),((a={})[n]=Array.isArray(s)?o([],i(s),!1):s,a))},{})}function T(e){var r,t;e="function"==typeof e.clone?e.clone():I(e);try{for(var i=n(Object.keys(e.headers)),o=i.next();!o.done;o=i.next()){var a=o.value;p.indexOf(a.toLowerCase())>-1&&delete e.headers[a]}}catch(e){r={error:e}}finally{try{o&&!o.done&&(t=i.return)&&t.call(i)}finally{if(r)throw r.error}}return e}!function(){function i(e){var r=e.applyChecksum,t=e.credentials,n=e.region,i=e.service,o=e.sha256,a=e.uriEscapePath,s=void 0===a||a;this.service=i,this.sha256=o,this.uriEscapePath=s,this.applyChecksum="boolean"!=typeof r||r,this.regionProvider=B(n),this.credentialProvider=N(t)}i.prototype.presign=function(i,o){return void 0===o&&(o={}),r(this,void 0,void 0,function(){var r,a,s,c,u,l,y,v,p,g,b,w,S,m,A,O,k,j,C,P,q,E,H,R;return t(this,function(t){switch(t.label){case 0:return r=o.signingDate,a=void 0===r?new Date:r,s=o.expiresIn,c=void 0===s?3600:s,u=o.unsignableHeaders,l=o.unhoistableHeaders,y=o.signableHeaders,v=o.signingRegion,p=o.signingService,[4,this.credentialProvider()];case 1:return g=t.sent(),null==v?[3,2]:(w=v,[3,4]);case 2:return[4,this.regionProvider()];case 3:w=t.sent(),t.label=4;case 4:return b=w,S=X(a),m=S.longDate,A=S.shortDate,c>604800?[2,Promise.reject("Signature version 4 presigned URLs must have an expiration date less than one week in the future")]:(O=D(A,b,null!=p?p:this.service),k=function(r,t){var i,o,a;void 0===t&&(t={});var s="function"==typeof r.clone?r.clone():I(r),c=s.headers,u=s.query,l=void 0===u?{}:u;try{for(var f=n(Object.keys(c)),h=f.next();!h.done;h=f.next()){var d=h.value,y=d.toLowerCase();"x-amz-"!==y.substr(0,6)||(null===(a=t.unhoistableHeaders)||void 0===a?void 0:a.has(y))||(l[d]=c[d],delete c[d])}}catch(e){i={error:e}}finally{try{h&&!h.done&&(o=f.return)&&o.call(f)}finally{if(i)throw i.error}}return e(e({},r),{headers:c,query:l})}(T(i),{unhoistableHeaders:l}),g.sessionToken&&(k.query[d]=g.sessionToken),k.query["X-Amz-Algorithm"]=x,k.query["X-Amz-Credential"]=g.accessKeyId+"/"+O,k.query[f]=m,k.query["X-Amz-Expires"]=c.toString(10),j=z(k,u,y),k.query["X-Amz-SignedHeaders"]=K(j),C=k.query,P=h,q=this.getSignature,E=[m,O,this.getSigningKey(g,b,A,p)],H=this.createCanonicalRequest,R=[k,j],[4,L(i,this.sha256)]);case 5:return[4,q.apply(this,E.concat([H.apply(this,R.concat([t.sent()]))]))];case 6:return C[P]=t.sent(),[2,k]}})})},i.prototype.sign=function(e,n){return r(this,void 0,void 0,function(){return t(this,function(r){return"string"==typeof e?[2,this.signString(e,n)]:e.headers&&e.payload?[2,this.signEvent(e,n)]:[2,this.signRequest(e,n)]})})},i.prototype.signEvent=function(e,n){var i=e.headers,o=e.payload,a=n.signingDate,s=void 0===a?new Date:a,c=n.priorSignature,u=n.signingRegion,f=n.signingService;return r(this,void 0,void 0,function(){var e,r,n,a,h,d,y,v,p,g,b;return t(this,function(t){switch(t.label){case 0:return null==u?[3,1]:(r=u,[3,3]);case 1:return[4,this.regionProvider()];case 2:r=t.sent(),t.label=3;case 3:return e=r,n=X(s),a=n.shortDate,h=n.longDate,d=D(a,e,null!=f?f:this.service),[4,L({headers:{},body:o},this.sha256)];case 4:return y=t.sent(),(v=new this.sha256).update(i),g=l,[4,v.digest()];case 5:return p=g.apply(void 0,[t.sent()]),b=[O,h,d,c,p,y].join("\n"),[2,this.signString(b,{signingDate:s,signingRegion:e,signingService:f})]}})})},i.prototype.signString=function(e,n){var i=void 0===n?{}:n,o=i.signingDate,a=void 0===o?new Date:o,s=i.signingRegion,c=i.signingService;return r(this,void 0,void 0,function(){var r,n,i,o,u,f,h,d;return t(this,function(t){switch(t.label){case 0:return[4,this.credentialProvider()];case 1:return r=t.sent(),null==s?[3,2]:(i=s,[3,4]);case 2:return[4,this.regionProvider()];case 3:i=t.sent(),t.label=4;case 4:return n=i,o=X(a).shortDate,h=(f=this.sha256).bind,[4,this.getSigningKey(r,n,o,c)];case 5:return(u=new(h.apply(f,[void 0,t.sent()]))).update(e),d=l,[4,u.digest()];case 6:return[2,d.apply(void 0,[t.sent()])]}})})},i.prototype.signRequest=function(e,i){var o=void 0===i?{}:i,a=o.signingDate,s=void 0===a?new Date:a,c=o.signableHeaders,u=o.unsignableHeaders,l=o.signingRegion,f=o.signingService;return r(this,void 0,void 0,function(){var r,i,o,a,h,d,p,g,S,m,A;return t(this,function(t){switch(t.label){case 0:return[4,this.credentialProvider()];case 1:return r=t.sent(),null==l?[3,2]:(o=l,[3,4]);case 2:return[4,this.regionProvider()];case 3:o=t.sent(),t.label=4;case 4:return i=o,a=T(e),h=X(s),d=h.longDate,p=h.shortDate,g=D(p,i,null!=f?f:this.service),a.headers[v]=d,r.sessionToken&&(a.headers[w]=r.sessionToken),[4,L(a,this.sha256)];case 5:return S=t.sent(),!function(e,r){var t,i;e=e.toLowerCase();try{for(var o=n(Object.keys(r)),a=o.next();!a.done;a=o.next())if(e===a.value.toLowerCase())return!0}catch(e){t={error:e}}finally{try{a&&!a.done&&(i=o.return)&&i.call(o)}finally{if(t)throw t.error}}return!1}(b,a.headers)&&this.applyChecksum&&(a.headers[b]=S),m=z(a,u,c),[4,this.getSignature(d,g,this.getSigningKey(r,i,p,f),this.createCanonicalRequest(a,m,S))];case 6:return A=t.sent(),a.headers[y]=x+" Credential="+r.accessKeyId+"/"+g+", SignedHeaders="+K(m)+", Signature="+A,[2,a]}})})},i.prototype.createCanonicalRequest=function(e,r,t){var i=Object.keys(r).sort();return e.method+"\n"+this.getCanonicalPath(e)+"\n"+function(e){var r,t,i=e.query,o=void 0===i?{}:i,a=[],s={},c=function(e){if(e.toLowerCase()===g)return"continue";a.push(e);var r=o[e];"string"==typeof r?s[e]=E(e)+"="+E(r):Array.isArray(r)&&(s[e]=r.slice(0).sort().reduce(function(r,t){return r.concat([E(e)+"="+E(t)])},[]).join("&"))};try{for(var u=n(Object.keys(o).sort()),l=u.next();!l.done;l=u.next())c(l.value)}catch(e){r={error:e}}finally{try{l&&!l.done&&(t=u.return)&&t.call(u)}finally{if(r)throw r.error}}return a.map(function(e){return s[e]}).filter(function(e){return e}).join("&")}(e)+"\n"+i.map(function(e){return e+":"+r[e]}).join("\n")+"\n\n"+i.join(";")+"\n"+t},i.prototype.createStringToSign=function(e,n,i){return r(this,void 0,void 0,function(){var r,o;return t(this,function(t){switch(t.label){case 0:return(r=new this.sha256).update(i),[4,r.digest()];case 1:return o=t.sent(),[2,x+"\n"+e+"\n"+n+"\n"+l(o)]}})})},i.prototype.getCanonicalPath=function(e){var r=e.path;return this.uriEscapePath?"/"+encodeURIComponent(r.replace(/^\//,"")).replace(/%2F/g,"/"):r},i.prototype.getSignature=function(e,n,i,o){return r(this,void 0,void 0,function(){var r,a,s,c,u;return t(this,function(t){switch(t.label){case 0:return[4,this.createStringToSign(e,n,o)];case 1:return r=t.sent(),c=(s=this.sha256).bind,[4,i];case 2:return(a=new(c.apply(s,[void 0,t.sent()]))).update(r),u=l,[4,a.digest()];case 3:return[2,u.apply(void 0,[t.sent()])]}})})},i.prototype.getSigningKey=function(e,r,t,n){return P(this.sha256,e,t,r,n||this.service)}}();var X=function(e){var r,t=(r=e,function(e){return"number"==typeof e?new Date(1e3*e):"string"==typeof e?Number(e)?new Date(1e3*Number(e)):new Date(e):e}(r).toISOString().replace(/\.\d{3}Z$/,"Z")).replace(/[\-:]/g,"");return{longDate:t,shortDate:t.substr(0,8)}},K=function(e){return Object.keys(e).sort().join(";")},B=function(e){if("string"==typeof e){var r=Promise.resolve(e);return function(){return r}}return e},N=function(e){if("object"==typeof e){var r=Promise.resolve(e);return function(){return r}}return e};function U(e){var r=e.port,t=e.query,i=e.protocol,o=e.path,a=e.hostname;i&&":"!==i.substr(-1)&&(i+=":"),r&&(a+=":"+r),o&&"/"!==o.charAt(0)&&(o="/"+o);var s=t?function(e){var r,t,i=[];try{for(var o=n(Object.keys(e).sort()),a=o.next();!a.done;a=o.next()){var s=a.value,c=e[s];if(s=E(s),Array.isArray(c))for(var u=0,l=c.length;u<l;u++)i.push(s+"="+E(c[u]));else{var f=s;(c||"string"==typeof c)&&(f+="="+E(c)),i.push(f)}}}catch(e){r={error:e}}finally{try{a&&!a.done&&(t=o.return)&&t.call(o)}finally{if(r)throw r.error}}return i.join("&")}(t):"";return s&&"?"!==s[0]&&(s="?"+s),i+"//"+a+o+s}var W=function(n,a){var s=a.Bucket,c=a.Key,u=a.Conditions,f=void 0===u?[]:u,h=a.Fields,d=void 0===h?{}:h,y=a.Expires,v=void 0===y?3600:y;return r(void 0,void 0,void 0,function(){var r,a,u,h,y,p,g,b,w,S,m,A,x,O,k,j,C,q,z,E,H,L;return t(this,function(t){switch(t.label){case 0:return r=n.config,a=r.systemClockOffset,u=r.base64Encoder,h=r.utf8Decoder,y=r.sha256,p=new Date(Date.now()+a),g=$(p).replace(/[\-:]/g,""),b=g.substr(0,8),[4,n.config.region()];case 1:return w=t.sent(),S=D(b,w,"s3"),[4,n.config.credentials()];case 2:return m=t.sent(),A=m.accessKeyId+"/"+S,x=e(e(e({},d),((E={bucket:s})["X-Amz-Algorithm"]="AWS4-HMAC-SHA256",E["X-Amz-Credential"]=A,E["X-Amz-Date"]=g,E)),m.sessionToken?((H={})["X-Amz-Security-Token"]=m.sessionToken,H):{}),O=new Date(p.valueOf()+1e3*v),k=o(o(o([],i(f),!1),i(Object.entries(x).map(function(e){var r,t=i(e,2),n=t[0],o=t[1];return(r={})[n]=o,r})),!1),[c.endsWith("${filename}")?["starts-with","$key",c.substring(0,c.lastIndexOf("${filename}"))]:{key:c}],!1),j=u(h(JSON.stringify({expiration:$(O),conditions:k}))),[4,P(y,m,b,w,"s3")];case 3:return C=t.sent(),[4,Z(y,C,j)];case 4:return q=t.sent(),[4,n.config.endpoint()];case 5:return z=t.sent(),n.config.bucketEndpoint||(z.path="/"+s),[2,{url:U(z),fields:e(e({},x),(L={key:c,Policy:j},L["X-Amz-Signature"]=l(q),L))}]}})})},$=function(e){return e.toISOString().replace(/\.\d{3}Z$/,"Z")},Z=function(e,r,t){var n=new e(r);return n.update(t),n.digest()};export{W as createPresignedPost};