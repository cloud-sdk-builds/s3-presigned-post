var e=function(){return e=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},e.apply(this,arguments)};function t(e,t,n,r){return new(n||(n=Promise))(function(o,i){function a(e){try{s(r.next(e))}catch(e){i(e)}}function c(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,c)}s((r=r.apply(e,t||[])).next())})}function n(e,t){var n,r,o,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=c(0),a.throw=c(1),a.return=c(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function c(c){return function(s){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,c[0]&&(i=0)),i;)try{if(n=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,r=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){i=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){i.label=c[1];break}if(6===c[0]&&i.label<o[1]){i.label=o[1],o=c;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(c);break}o[2]&&i.ops.pop(),i.trys.pop();continue}c=t.call(e,i)}catch(e){c=[6,e],r=0}finally{n=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,s])}}}function r(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function o(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a}function i(e,t,n){if(n||2===arguments.length)for(var r,o=0,i=t.length;o<i;o++)!r&&o in t||(r||(r=Array.prototype.slice.call(t,0,o)),r[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))}Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;for(var a={},c={},s=0;s<256;s++){var u=s.toString(16).toLowerCase();1===u.length&&(u="0".concat(u)),a[s]=u,c[u]=s}function l(e){for(var t="",n=0;n<e.byteLength;n++)t+=a[e[n]];return t}var f=function(e){if("function"==typeof e)return e;var t=Promise.resolve(e);return function(){return t}},d="X-Amz-Date",h="X-Amz-Signature",y="X-Amz-Security-Token",v="authorization",p=d.toLowerCase(),g=[v,p,"date"],b=h.toLowerCase(),w="x-amz-content-sha256",S=y.toLowerCase(),m={authorization:!0,"cache-control":!0,connection:!0,expect:!0,from:!0,"keep-alive":!0,"max-forwards":!0,pragma:!0,referer:!0,te:!0,trailer:!0,"transfer-encoding":!0,upgrade:!0,"user-agent":!0,"x-amzn-trace-id":!0},A=/^proxy-/,x=/^sec-/,O="AWS4-HMAC-SHA256",j="AWS4-HMAC-SHA256-PAYLOAD",k="aws4_request",C={},D=[],P=function(e,t,n){return"".concat(e,"/").concat(t,"/").concat(n,"/").concat(k)},q=function(e,o,i,a,c){return t(void 0,void 0,void 0,function(){var t,s,u,f,d,h,y,v,p;return n(this,function(n){switch(n.label){case 0:return[4,R(e,o.secretAccessKey,o.accessKeyId)];case 1:if(t=n.sent(),(s="".concat(i,":").concat(a,":").concat(c,":").concat(l(t),":").concat(o.sessionToken))in C)return[2,C[s]];for(D.push(s);D.length>50;)delete C[D.shift()];u="AWS4".concat(o.secretAccessKey),n.label=2;case 2:n.trys.push([2,7,8,9]),f=r([i,a,c,k]),d=f.next(),n.label=3;case 3:return d.done?[3,6]:(h=d.value,[4,R(e,u,h)]);case 4:u=n.sent(),n.label=5;case 5:return d=f.next(),[3,3];case 6:return[3,9];case 7:return y=n.sent(),v={error:y},[3,9];case 8:try{d&&!d.done&&(p=f.return)&&p.call(f)}finally{if(v)throw v.error}return[7];case 9:return[2,C[s]=u]}})})},R=function(e,t,n){var r=new e(t);return r.update(n),r.digest()},z=function(e,t,n){var o,i,a=e.headers,c={};try{for(var s=r(Object.keys(a).sort()),u=s.next();!u.done;u=s.next()){var l=u.value;if(null!=a[l]){var f=l.toLowerCase();(f in m||(null==t?void 0:t.has(f))||A.test(f)||x.test(f))&&(!n||n&&!n.has(f))||(c[f]=a[l].trim().replace(/\s+/g," "))}}}catch(e){o={error:e}}finally{try{u&&!u.done&&(i=s.return)&&i.call(s)}finally{if(o)throw o.error}}return c},E=function(e){return encodeURIComponent(e).replace(/[!'()*]/g,H)},H=function(e){return"%".concat(e.charCodeAt(0).toString(16).toUpperCase())},I=function(e,o){var i=e.headers,a=e.body;return t(void 0,void 0,void 0,function(){var e,t,c,s,u,f,d;return n(this,function(n){switch(n.label){case 0:try{for(e=r(Object.keys(i)),t=e.next();!t.done;t=e.next())if((c=t.value).toLowerCase()===w)return[2,i[c]]}catch(e){f={error:e}}finally{try{t&&!t.done&&(d=e.return)&&d.call(e)}finally{if(f)throw f.error}}return null!=a?[3,1]:[2,"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"];case 1:return"string"==typeof a||ArrayBuffer.isView(a)||(h=a,"function"==typeof ArrayBuffer&&h instanceof ArrayBuffer||"[object ArrayBuffer]"===Object.prototype.toString.call(h))?((s=new o).update(a),u=l,[4,s.digest()]):[3,3];case 2:return[2,u.apply(void 0,[n.sent()])];case 3:return[2,"UNSIGNED-PAYLOAD"]}var h})})},L=function(t){var n=t.headers,r=t.query,o=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n}(t,["headers","query"]);return e(e({},o),{headers:e({},n),query:r?K(r):void 0})},K=function(t){return Object.keys(t).reduce(function(n,r){var a,c=t[r];return e(e({},n),((a={})[r]=Array.isArray(c)?i([],o(c),!1):c,a))},{})},T=function(e){var t,n;e="function"==typeof e.clone?e.clone():L(e);try{for(var o=r(Object.keys(e.headers)),i=o.next();!i.done;i=o.next()){var a=i.value;g.indexOf(a.toLowerCase())>-1&&delete e.headers[a]}}catch(e){t={error:e}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}return e},X=(function(){function o(e){var t=e.applyChecksum,n=e.credentials,r=e.region,o=e.service,i=e.sha256,a=e.uriEscapePath,c=void 0===a||a;this.service=o,this.sha256=i,this.uriEscapePath=c,this.applyChecksum="boolean"!=typeof t||t,this.regionProvider=f(r),this.credentialProvider=f(n)}o.prototype.presign=function(o,i){return void 0===i&&(i={}),t(this,void 0,void 0,function(){var t,a,c,s,u,l,f,v,p,g,b,w,S,m,A,x,j,k,C,D,q,R,E,H;return n(this,function(n){switch(n.label){case 0:return t=i.signingDate,a=void 0===t?new Date:t,c=i.expiresIn,s=void 0===c?3600:c,u=i.unsignableHeaders,l=i.unhoistableHeaders,f=i.signableHeaders,v=i.signingRegion,p=i.signingService,[4,this.credentialProvider()];case 1:return g=n.sent(),this.validateResolvedCredentials(g),null==v?[3,2]:(w=v,[3,4]);case 2:return[4,this.regionProvider()];case 3:w=n.sent(),n.label=4;case 4:return b=w,S=X(a),m=S.longDate,A=S.shortDate,s>604800?[2,Promise.reject("Signature version 4 presigned URLs must have an expiration date less than one week in the future")]:(x=P(A,b,null!=p?p:this.service),j=function(t,n){var o,i,a;void 0===n&&(n={});var c="function"==typeof t.clone?t.clone():L(t),s=c.headers,u=c.query,l=void 0===u?{}:u;try{for(var f=r(Object.keys(s)),d=f.next();!d.done;d=f.next()){var h=d.value,y=h.toLowerCase();"x-amz-"!==y.slice(0,6)||(null===(a=n.unhoistableHeaders)||void 0===a?void 0:a.has(y))||(l[h]=s[h],delete s[h])}}catch(e){o={error:e}}finally{try{d&&!d.done&&(i=f.return)&&i.call(f)}finally{if(o)throw o.error}}return e(e({},t),{headers:s,query:l})}(T(o),{unhoistableHeaders:l}),g.sessionToken&&(j.query[y]=g.sessionToken),j.query["X-Amz-Algorithm"]=O,j.query["X-Amz-Credential"]="".concat(g.accessKeyId,"/").concat(x),j.query[d]=m,j.query["X-Amz-Expires"]=s.toString(10),k=z(j,u,f),j.query["X-Amz-SignedHeaders"]=W(k),C=j.query,D=h,q=this.getSignature,R=[m,x,this.getSigningKey(g,b,A,p)],E=this.createCanonicalRequest,H=[j,k],[4,I(o,this.sha256)]);case 5:return[4,q.apply(this,R.concat([E.apply(this,H.concat([n.sent()]))]))];case 6:return C[D]=n.sent(),[2,j]}})})},o.prototype.sign=function(e,r){return t(this,void 0,void 0,function(){return n(this,function(t){return"string"==typeof e?[2,this.signString(e,r)]:e.headers&&e.payload?[2,this.signEvent(e,r)]:[2,this.signRequest(e,r)]})})},o.prototype.signEvent=function(e,r){var o=e.headers,i=e.payload,a=r.signingDate,c=void 0===a?new Date:a,s=r.priorSignature,u=r.signingRegion,f=r.signingService;return t(this,void 0,void 0,function(){var e,t,r,a,d,h,y,v,p,g,b;return n(this,function(n){switch(n.label){case 0:return null==u?[3,1]:(t=u,[3,3]);case 1:return[4,this.regionProvider()];case 2:t=n.sent(),n.label=3;case 3:return e=t,r=X(c),a=r.shortDate,d=r.longDate,h=P(a,e,null!=f?f:this.service),[4,I({headers:{},body:i},this.sha256)];case 4:return y=n.sent(),(v=new this.sha256).update(o),g=l,[4,v.digest()];case 5:return p=g.apply(void 0,[n.sent()]),b=[j,d,h,s,p,y].join("\n"),[2,this.signString(b,{signingDate:c,signingRegion:e,signingService:f})]}})})},o.prototype.signString=function(e,r){var o=void 0===r?{}:r,i=o.signingDate,a=void 0===i?new Date:i,c=o.signingRegion,s=o.signingService;return t(this,void 0,void 0,function(){var t,r,o,i,u,f,d,h;return n(this,function(n){switch(n.label){case 0:return[4,this.credentialProvider()];case 1:return t=n.sent(),this.validateResolvedCredentials(t),null==c?[3,2]:(o=c,[3,4]);case 2:return[4,this.regionProvider()];case 3:o=n.sent(),n.label=4;case 4:return r=o,i=X(a).shortDate,d=(f=this.sha256).bind,[4,this.getSigningKey(t,r,i,s)];case 5:return(u=new(d.apply(f,[void 0,n.sent()]))).update(e),h=l,[4,u.digest()];case 6:return[2,h.apply(void 0,[n.sent()])]}})})},o.prototype.signRequest=function(e,o){var i=void 0===o?{}:o,a=i.signingDate,c=void 0===a?new Date:a,s=i.signableHeaders,u=i.unsignableHeaders,l=i.signingRegion,f=i.signingService;return t(this,void 0,void 0,function(){var t,o,i,a,d,h,y,g,b,m,A;return n(this,function(n){switch(n.label){case 0:return[4,this.credentialProvider()];case 1:return t=n.sent(),this.validateResolvedCredentials(t),null==l?[3,2]:(i=l,[3,4]);case 2:return[4,this.regionProvider()];case 3:i=n.sent(),n.label=4;case 4:return o=i,a=T(e),d=X(c),h=d.longDate,y=d.shortDate,g=P(y,o,null!=f?f:this.service),a.headers[p]=h,t.sessionToken&&(a.headers[S]=t.sessionToken),[4,I(a,this.sha256)];case 5:return b=n.sent(),!function(e,t){var n,o;e=e.toLowerCase();try{for(var i=r(Object.keys(t)),a=i.next();!a.done;a=i.next())if(e===a.value.toLowerCase())return!0}catch(e){n={error:e}}finally{try{a&&!a.done&&(o=i.return)&&o.call(i)}finally{if(n)throw n.error}}return!1}(w,a.headers)&&this.applyChecksum&&(a.headers[w]=b),m=z(a,u,s),[4,this.getSignature(h,g,this.getSigningKey(t,o,y,f),this.createCanonicalRequest(a,m,b))];case 6:return A=n.sent(),a.headers[v]="".concat(O," ")+"Credential=".concat(t.accessKeyId,"/").concat(g,", ")+"SignedHeaders=".concat(W(m),", ")+"Signature=".concat(A),[2,a]}})})},o.prototype.createCanonicalRequest=function(e,t,n){var o=Object.keys(t).sort();return"".concat(e.method,"\n").concat(this.getCanonicalPath(e),"\n").concat(function(e){var t,n,o=e.query,i=void 0===o?{}:o,a=[],c={},s=function(e){if(e.toLowerCase()===b)return"continue";a.push(e);var t=i[e];"string"==typeof t?c[e]="".concat(E(e),"=").concat(E(t)):Array.isArray(t)&&(c[e]=t.slice(0).sort().reduce(function(t,n){return t.concat(["".concat(E(e),"=").concat(E(n))])},[]).join("&"))};try{for(var u=r(Object.keys(i).sort()),l=u.next();!l.done;l=u.next())s(l.value)}catch(e){t={error:e}}finally{try{l&&!l.done&&(n=u.return)&&n.call(u)}finally{if(t)throw t.error}}return a.map(function(e){return c[e]}).filter(function(e){return e}).join("&")}(e),"\n").concat(o.map(function(e){return"".concat(e,":").concat(t[e])}).join("\n"),"\n\n").concat(o.join(";"),"\n").concat(n)},o.prototype.createStringToSign=function(e,r,o){return t(this,void 0,void 0,function(){var t,i;return n(this,function(n){switch(n.label){case 0:return(t=new this.sha256).update(o),[4,t.digest()];case 1:return i=n.sent(),[2,"".concat(O,"\n").concat(e,"\n").concat(r,"\n").concat(l(i))]}})})},o.prototype.getCanonicalPath=function(e){var t,n,o=e.path;if(this.uriEscapePath){var i=[];try{for(var a=r(o.split("/")),c=a.next();!c.done;c=a.next()){var s=c.value;0!==(null==s?void 0:s.length)&&"."!==s&&(".."===s?i.pop():i.push(s))}}catch(e){t={error:e}}finally{try{c&&!c.done&&(n=a.return)&&n.call(a)}finally{if(t)throw t.error}}var u="".concat((null==o?void 0:o.startsWith("/"))?"/":"").concat(i.join("/")).concat(i.length>0&&(null==o?void 0:o.endsWith("/"))?"/":"");return encodeURIComponent(u).replace(/%2F/g,"/")}return o},o.prototype.getSignature=function(e,r,o,i){return t(this,void 0,void 0,function(){var t,a,c,s,u;return n(this,function(n){switch(n.label){case 0:return[4,this.createStringToSign(e,r,i)];case 1:return t=n.sent(),s=(c=this.sha256).bind,[4,o];case 2:return(a=new(s.apply(c,[void 0,n.sent()]))).update(t),u=l,[4,a.digest()];case 3:return[2,u.apply(void 0,[n.sent()])]}})})},o.prototype.getSigningKey=function(e,t,n,r){return q(this.sha256,e,n,t,r||this.service)},o.prototype.validateResolvedCredentials=function(e){if("object"!=typeof e||"string"!=typeof e.accessKeyId||"string"!=typeof e.secretAccessKey)throw new Error("Resolved credential object is not valid")}}(),function(e){var t,n=(t=e,function(e){return"number"==typeof e?new Date(1e3*e):"string"==typeof e?Number(e)?new Date(1e3*Number(e)):new Date(e):e}(t).toISOString().replace(/\.\d{3}Z$/,"Z")).replace(/[\-:]/g,"");return{longDate:n,shortDate:n.slice(0,8)}}),W=function(e){return Object.keys(e).sort().join(";")};function B(e){var t=e.port,n=e.query,o=e.protocol,i=e.path,a=e.hostname;o&&":"!==o.slice(-1)&&(o+=":"),t&&(a+=":".concat(t)),i&&"/"!==i.charAt(0)&&(i="/".concat(i));var c=n?function(e){var t,n,o=[];try{for(var i=r(Object.keys(e).sort()),a=i.next();!a.done;a=i.next()){var c=a.value,s=e[c];if(c=E(c),Array.isArray(s))for(var u=0,l=s.length;u<l;u++)o.push("".concat(c,"=").concat(E(s[u])));else{var f=c;(s||"string"==typeof s)&&(f+="=".concat(E(s))),o.push(f)}}}catch(e){t={error:e}}finally{try{a&&!a.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}return o.join("&")}(n):"";return c&&"?"!==c[0]&&(c="?".concat(c)),"".concat(o,"//").concat(a).concat(i).concat(c)}var N=function(r,a){var c=a.Bucket,s=a.Key,u=a.Conditions,f=void 0===u?[]:u,d=a.Fields,h=void 0===d?{}:d,y=a.Expires,v=void 0===y?3600:y;return t(void 0,void 0,void 0,function(){var t,a,u,d,y,p,g,b,w,S,m,A,x,O,j,k,C,D,R,z,E,H;return n(this,function(n){switch(n.label){case 0:return t=r.config,a=t.systemClockOffset,u=t.base64Encoder,d=t.utf8Decoder,y=t.sha256,p=new Date(Date.now()+a),g=U(p).replace(/[\-:]/g,""),b=g.slice(0,8),[4,r.config.region()];case 1:return w=n.sent(),S=P(b,w,"s3"),[4,r.config.credentials()];case 2:return m=n.sent(),A="".concat(m.accessKeyId,"/").concat(S),x=e(e(e({},h),((z={bucket:c})["X-Amz-Algorithm"]="AWS4-HMAC-SHA256",z["X-Amz-Credential"]=A,z["X-Amz-Date"]=g,z)),m.sessionToken?((E={})["X-Amz-Security-Token"]=m.sessionToken,E):{}),O=new Date(p.valueOf()+1e3*v),j=i(i(i([],o(f),!1),o(Object.entries(x).map(function(e){var t,n=o(e,2),r=n[0],i=n[1];return(t={})[r]=i,t})),!1),[s.endsWith("${filename}")?["starts-with","$key",s.substring(0,s.lastIndexOf("${filename}"))]:{key:s}],!1),k=u(d(JSON.stringify({expiration:U(O),conditions:j}))),[4,q(y,m,b,w,"s3")];case 3:return C=n.sent(),[4,$(y,C,k)];case 4:return D=n.sent(),[4,r.config.endpoint()];case 5:return R=n.sent(),r.config.bucketEndpoint||(R.path="/".concat(c)),[2,{url:B(R),fields:e(e({},x),(H={key:s,Policy:k},H["X-Amz-Signature"]=l(D),H))}]}})})},U=function(e){return e.toISOString().replace(/\.\d{3}Z$/,"Z")},$=function(e,t,n){var r=new e(t);return r.update(n),r.digest()};export{N as createPresignedPost};