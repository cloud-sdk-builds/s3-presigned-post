var e=function(){return e=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},e.apply(this,arguments)};function t(e,t,n,r){return new(n||(n=Promise))(function(o,a){function i(e){try{s(r.next(e))}catch(e){a(e)}}function c(e){try{s(r.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(i,c)}s((r=r.apply(e,t||[])).next())})}function n(e,t){var n,r,o,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=c(0),i.throw=c(1),i.return=c(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(s){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return a.label++,{value:c[1],done:!1};case 5:a.label++,r=c[1],c=[0];continue;case 7:c=a.ops.pop(),a.trys.pop();continue;default:if(!((o=(o=a.trys).length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){a=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){a.label=c[1];break}if(6===c[0]&&a.label<o[1]){a.label=o[1],o=c;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(c);break}o[2]&&a.ops.pop(),a.trys.pop();continue}c=t.call(e,a)}catch(e){c=[6,e],r=0}finally{n=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,s])}}}function r(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function o(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,a=n.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(r=a.next()).done;)i.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=a.return)&&n.call(a)}finally{if(o)throw o.error}}return i}function a(e,t,n){if(n||2===arguments.length)for(var r,o=0,a=t.length;o<a;o++)!r&&o in t||(r||(r=Array.prototype.slice.call(t,0,o)),r[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))}Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;for(var i={},c={},s=0;s<256;s++){var u=s.toString(16).toLowerCase();1===u.length&&(u="0".concat(u)),i[s]=u,c[u]=s}function l(e){for(var t="",n=0;n<e.byteLength;n++)t+=i[e[n]];return t}var f=function(e){if("function"==typeof e)return e;var t=Promise.resolve(e);return function(){return t}},h="X-Amz-Date",d="X-Amz-Signature",y="X-Amz-Security-Token",v="authorization",p=h.toLowerCase(),g=[v,p,"date"],b=d.toLowerCase(),w="x-amz-content-sha256",S=y.toLowerCase(),m={authorization:!0,"cache-control":!0,connection:!0,expect:!0,from:!0,"keep-alive":!0,"max-forwards":!0,pragma:!0,referer:!0,te:!0,trailer:!0,"transfer-encoding":!0,upgrade:!0,"user-agent":!0,"x-amzn-trace-id":!0},A=/^proxy-/,x=/^sec-/,O="AWS4-HMAC-SHA256",k="AWS4-HMAC-SHA256-PAYLOAD",j="aws4_request",C={},D=[],P=function(e,t,n){return"".concat(e,"/").concat(t,"/").concat(n,"/").concat(j)},q=function(e,o,a,i,c){return t(void 0,void 0,void 0,function(){var t,s,u,f,h,d,y,v,p;return n(this,function(n){switch(n.label){case 0:return[4,z(e,o.secretAccessKey,o.accessKeyId)];case 1:if(t=n.sent(),(s="".concat(a,":").concat(i,":").concat(c,":").concat(l(t),":").concat(o.sessionToken))in C)return[2,C[s]];for(D.push(s);D.length>50;)delete C[D.shift()];u="AWS4".concat(o.secretAccessKey),n.label=2;case 2:n.trys.push([2,7,8,9]),f=r([a,i,c,j]),h=f.next(),n.label=3;case 3:return h.done?[3,6]:(d=h.value,[4,z(e,u,d)]);case 4:u=n.sent(),n.label=5;case 5:return h=f.next(),[3,3];case 6:return[3,9];case 7:return y=n.sent(),v={error:y},[3,9];case 8:try{h&&!h.done&&(p=f.return)&&p.call(f)}finally{if(v)throw v.error}return[7];case 9:return[2,C[s]=u]}})})},z=function(e,t,n){var r=new e(t);return r.update(n),r.digest()},E=function(e,t,n){var o,a,i=e.headers,c={};try{for(var s=r(Object.keys(i).sort()),u=s.next();!u.done;u=s.next()){var l=u.value,f=l.toLowerCase();(f in m||(null==t?void 0:t.has(f))||A.test(f)||x.test(f))&&(!n||n&&!n.has(f))||(c[f]=i[l].trim().replace(/\s+/g," "))}}catch(e){o={error:e}}finally{try{u&&!u.done&&(a=s.return)&&a.call(s)}finally{if(o)throw o.error}}return c},H=function(e){return encodeURIComponent(e).replace(/[!'()*]/g,L)},L=function(e){return"%".concat(e.charCodeAt(0).toString(16).toUpperCase())},I=function(e,o){var a=e.headers,i=e.body;return t(void 0,void 0,void 0,function(){var e,t,c,s,u,f,h;return n(this,function(n){switch(n.label){case 0:try{for(e=r(Object.keys(a)),t=e.next();!t.done;t=e.next())if((c=t.value).toLowerCase()===w)return[2,a[c]]}catch(e){f={error:e}}finally{try{t&&!t.done&&(h=e.return)&&h.call(e)}finally{if(f)throw f.error}}return null!=i?[3,1]:[2,"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"];case 1:return"string"==typeof i||ArrayBuffer.isView(i)||(d=i,"function"==typeof ArrayBuffer&&d instanceof ArrayBuffer||"[object ArrayBuffer]"===Object.prototype.toString.call(d))?((s=new o).update(i),u=l,[4,s.digest()]):[3,3];case 2:return[2,u.apply(void 0,[n.sent()])];case 3:return[2,"UNSIGNED-PAYLOAD"]}var d})})},R=function(t){var n=t.headers,r=t.query,o=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n}(t,["headers","query"]);return e(e({},o),{headers:e({},n),query:r?T(r):void 0})},T=function(t){return Object.keys(t).reduce(function(n,r){var i,c=t[r];return e(e({},n),((i={})[r]=Array.isArray(c)?a([],o(c),!1):c,i))},{})},X=function(e){var t,n;e="function"==typeof e.clone?e.clone():R(e);try{for(var o=r(Object.keys(e.headers)),a=o.next();!a.done;a=o.next()){var i=a.value;g.indexOf(i.toLowerCase())>-1&&delete e.headers[i]}}catch(e){t={error:e}}finally{try{a&&!a.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}return e},K=(function(){function o(e){var t=e.applyChecksum,n=e.credentials,r=e.region,o=e.service,a=e.sha256,i=e.uriEscapePath,c=void 0===i||i;this.service=o,this.sha256=a,this.uriEscapePath=c,this.applyChecksum="boolean"!=typeof t||t,this.regionProvider=f(r),this.credentialProvider=f(n)}o.prototype.presign=function(o,a){return void 0===a&&(a={}),t(this,void 0,void 0,function(){var t,i,c,s,u,l,f,v,p,g,b,w,S,m,A,x,k,j,C,D,q,z,H,L;return n(this,function(n){switch(n.label){case 0:return t=a.signingDate,i=void 0===t?new Date:t,c=a.expiresIn,s=void 0===c?3600:c,u=a.unsignableHeaders,l=a.unhoistableHeaders,f=a.signableHeaders,v=a.signingRegion,p=a.signingService,[4,this.credentialProvider()];case 1:return g=n.sent(),null==v?[3,2]:(w=v,[3,4]);case 2:return[4,this.regionProvider()];case 3:w=n.sent(),n.label=4;case 4:return b=w,S=K(i),m=S.longDate,A=S.shortDate,s>604800?[2,Promise.reject("Signature version 4 presigned URLs must have an expiration date less than one week in the future")]:(x=P(A,b,null!=p?p:this.service),k=function(t,n){var o,a,i;void 0===n&&(n={});var c="function"==typeof t.clone?t.clone():R(t),s=c.headers,u=c.query,l=void 0===u?{}:u;try{for(var f=r(Object.keys(s)),h=f.next();!h.done;h=f.next()){var d=h.value,y=d.toLowerCase();"x-amz-"!==y.substr(0,6)||(null===(i=n.unhoistableHeaders)||void 0===i?void 0:i.has(y))||(l[d]=s[d],delete s[d])}}catch(e){o={error:e}}finally{try{h&&!h.done&&(a=f.return)&&a.call(f)}finally{if(o)throw o.error}}return e(e({},t),{headers:s,query:l})}(X(o),{unhoistableHeaders:l}),g.sessionToken&&(k.query[y]=g.sessionToken),k.query["X-Amz-Algorithm"]=O,k.query["X-Amz-Credential"]="".concat(g.accessKeyId,"/").concat(x),k.query[h]=m,k.query["X-Amz-Expires"]=s.toString(10),j=E(k,u,f),k.query["X-Amz-SignedHeaders"]=W(j),C=k.query,D=d,q=this.getSignature,z=[m,x,this.getSigningKey(g,b,A,p)],H=this.createCanonicalRequest,L=[k,j],[4,I(o,this.sha256)]);case 5:return[4,q.apply(this,z.concat([H.apply(this,L.concat([n.sent()]))]))];case 6:return C[D]=n.sent(),[2,k]}})})},o.prototype.sign=function(e,r){return t(this,void 0,void 0,function(){return n(this,function(t){return"string"==typeof e?[2,this.signString(e,r)]:e.headers&&e.payload?[2,this.signEvent(e,r)]:[2,this.signRequest(e,r)]})})},o.prototype.signEvent=function(e,r){var o=e.headers,a=e.payload,i=r.signingDate,c=void 0===i?new Date:i,s=r.priorSignature,u=r.signingRegion,f=r.signingService;return t(this,void 0,void 0,function(){var e,t,r,i,h,d,y,v,p,g,b;return n(this,function(n){switch(n.label){case 0:return null==u?[3,1]:(t=u,[3,3]);case 1:return[4,this.regionProvider()];case 2:t=n.sent(),n.label=3;case 3:return e=t,r=K(c),i=r.shortDate,h=r.longDate,d=P(i,e,null!=f?f:this.service),[4,I({headers:{},body:a},this.sha256)];case 4:return y=n.sent(),(v=new this.sha256).update(o),g=l,[4,v.digest()];case 5:return p=g.apply(void 0,[n.sent()]),b=[k,h,d,s,p,y].join("\n"),[2,this.signString(b,{signingDate:c,signingRegion:e,signingService:f})]}})})},o.prototype.signString=function(e,r){var o=void 0===r?{}:r,a=o.signingDate,i=void 0===a?new Date:a,c=o.signingRegion,s=o.signingService;return t(this,void 0,void 0,function(){var t,r,o,a,u,f,h,d;return n(this,function(n){switch(n.label){case 0:return[4,this.credentialProvider()];case 1:return t=n.sent(),null==c?[3,2]:(o=c,[3,4]);case 2:return[4,this.regionProvider()];case 3:o=n.sent(),n.label=4;case 4:return r=o,a=K(i).shortDate,h=(f=this.sha256).bind,[4,this.getSigningKey(t,r,a,s)];case 5:return(u=new(h.apply(f,[void 0,n.sent()]))).update(e),d=l,[4,u.digest()];case 6:return[2,d.apply(void 0,[n.sent()])]}})})},o.prototype.signRequest=function(e,o){var a=void 0===o?{}:o,i=a.signingDate,c=void 0===i?new Date:i,s=a.signableHeaders,u=a.unsignableHeaders,l=a.signingRegion,f=a.signingService;return t(this,void 0,void 0,function(){var t,o,a,i,h,d,y,g,b,m,A;return n(this,function(n){switch(n.label){case 0:return[4,this.credentialProvider()];case 1:return t=n.sent(),null==l?[3,2]:(a=l,[3,4]);case 2:return[4,this.regionProvider()];case 3:a=n.sent(),n.label=4;case 4:return o=a,i=X(e),h=K(c),d=h.longDate,y=h.shortDate,g=P(y,o,null!=f?f:this.service),i.headers[p]=d,t.sessionToken&&(i.headers[S]=t.sessionToken),[4,I(i,this.sha256)];case 5:return b=n.sent(),!function(e,t){var n,o;e=e.toLowerCase();try{for(var a=r(Object.keys(t)),i=a.next();!i.done;i=a.next())if(e===i.value.toLowerCase())return!0}catch(e){n={error:e}}finally{try{i&&!i.done&&(o=a.return)&&o.call(a)}finally{if(n)throw n.error}}return!1}(w,i.headers)&&this.applyChecksum&&(i.headers[w]=b),m=E(i,u,s),[4,this.getSignature(d,g,this.getSigningKey(t,o,y,f),this.createCanonicalRequest(i,m,b))];case 6:return A=n.sent(),i.headers[v]="".concat(O," ")+"Credential=".concat(t.accessKeyId,"/").concat(g,", ")+"SignedHeaders=".concat(W(m),", ")+"Signature=".concat(A),[2,i]}})})},o.prototype.createCanonicalRequest=function(e,t,n){var o=Object.keys(t).sort();return"".concat(e.method,"\n").concat(this.getCanonicalPath(e),"\n").concat(function(e){var t,n,o=e.query,a=void 0===o?{}:o,i=[],c={},s=function(e){if(e.toLowerCase()===b)return"continue";i.push(e);var t=a[e];"string"==typeof t?c[e]="".concat(H(e),"=").concat(H(t)):Array.isArray(t)&&(c[e]=t.slice(0).sort().reduce(function(t,n){return t.concat(["".concat(H(e),"=").concat(H(n))])},[]).join("&"))};try{for(var u=r(Object.keys(a).sort()),l=u.next();!l.done;l=u.next())s(l.value)}catch(e){t={error:e}}finally{try{l&&!l.done&&(n=u.return)&&n.call(u)}finally{if(t)throw t.error}}return i.map(function(e){return c[e]}).filter(function(e){return e}).join("&")}(e),"\n").concat(o.map(function(e){return"".concat(e,":").concat(t[e])}).join("\n"),"\n\n").concat(o.join(";"),"\n").concat(n)},o.prototype.createStringToSign=function(e,r,o){return t(this,void 0,void 0,function(){var t,a;return n(this,function(n){switch(n.label){case 0:return(t=new this.sha256).update(o),[4,t.digest()];case 1:return a=n.sent(),[2,"".concat(O,"\n").concat(e,"\n").concat(r,"\n").concat(l(a))]}})})},o.prototype.getCanonicalPath=function(e){var t,n,o=e.path;if(this.uriEscapePath){var a=[];try{for(var i=r(o.split("/")),c=i.next();!c.done;c=i.next()){var s=c.value;0!==(null==s?void 0:s.length)&&"."!==s&&(".."===s?a.pop():a.push(s))}}catch(e){t={error:e}}finally{try{c&&!c.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}var u="".concat((null==o?void 0:o.startsWith("/"))?"/":"").concat(a.join("/")).concat(a.length>0&&(null==o?void 0:o.endsWith("/"))?"/":"");return encodeURIComponent(u).replace(/%2F/g,"/")}return o},o.prototype.getSignature=function(e,r,o,a){return t(this,void 0,void 0,function(){var t,i,c,s,u;return n(this,function(n){switch(n.label){case 0:return[4,this.createStringToSign(e,r,a)];case 1:return t=n.sent(),s=(c=this.sha256).bind,[4,o];case 2:return(i=new(s.apply(c,[void 0,n.sent()]))).update(t),u=l,[4,i.digest()];case 3:return[2,u.apply(void 0,[n.sent()])]}})})},o.prototype.getSigningKey=function(e,t,n,r){return q(this.sha256,e,n,t,r||this.service)}}(),function(e){var t,n=(t=e,function(e){return"number"==typeof e?new Date(1e3*e):"string"==typeof e?Number(e)?new Date(1e3*Number(e)):new Date(e):e}(t).toISOString().replace(/\.\d{3}Z$/,"Z")).replace(/[\-:]/g,"");return{longDate:n,shortDate:n.substr(0,8)}}),W=function(e){return Object.keys(e).sort().join(";")};function B(e){var t=e.port,n=e.query,o=e.protocol,a=e.path,i=e.hostname;o&&":"!==o.substr(-1)&&(o+=":"),t&&(i+=":".concat(t)),a&&"/"!==a.charAt(0)&&(a="/".concat(a));var c=n?function(e){var t,n,o=[];try{for(var a=r(Object.keys(e).sort()),i=a.next();!i.done;i=a.next()){var c=i.value,s=e[c];if(c=H(c),Array.isArray(s))for(var u=0,l=s.length;u<l;u++)o.push("".concat(c,"=").concat(H(s[u])));else{var f=c;(s||"string"==typeof s)&&(f+="=".concat(H(s))),o.push(f)}}}catch(e){t={error:e}}finally{try{i&&!i.done&&(n=a.return)&&n.call(a)}finally{if(t)throw t.error}}return o.join("&")}(n):"";return c&&"?"!==c[0]&&(c="?".concat(c)),"".concat(o,"//").concat(i).concat(a).concat(c)}var N=function(r,i){var c=i.Bucket,s=i.Key,u=i.Conditions,f=void 0===u?[]:u,h=i.Fields,d=void 0===h?{}:h,y=i.Expires,v=void 0===y?3600:y;return t(void 0,void 0,void 0,function(){var t,i,u,h,y,p,g,b,w,S,m,A,x,O,k,j,C,D,z,E,H,L;return n(this,function(n){switch(n.label){case 0:return t=r.config,i=t.systemClockOffset,u=t.base64Encoder,h=t.utf8Decoder,y=t.sha256,p=new Date(Date.now()+i),g=U(p).replace(/[\-:]/g,""),b=g.substr(0,8),[4,r.config.region()];case 1:return w=n.sent(),S=P(b,w,"s3"),[4,r.config.credentials()];case 2:return m=n.sent(),A="".concat(m.accessKeyId,"/").concat(S),x=e(e(e({},d),((E={bucket:c})["X-Amz-Algorithm"]="AWS4-HMAC-SHA256",E["X-Amz-Credential"]=A,E["X-Amz-Date"]=g,E)),m.sessionToken?((H={})["X-Amz-Security-Token"]=m.sessionToken,H):{}),O=new Date(p.valueOf()+1e3*v),k=a(a(a([],o(f),!1),o(Object.entries(x).map(function(e){var t,n=o(e,2),r=n[0],a=n[1];return(t={})[r]=a,t})),!1),[s.endsWith("${filename}")?["starts-with","$key",s.substring(0,s.lastIndexOf("${filename}"))]:{key:s}],!1),j=u(h(JSON.stringify({expiration:U(O),conditions:k}))),[4,q(y,m,b,w,"s3")];case 3:return C=n.sent(),[4,$(y,C,j)];case 4:return D=n.sent(),[4,r.config.endpoint()];case 5:return z=n.sent(),r.config.bucketEndpoint||(z.path="/".concat(c)),[2,{url:B(z),fields:e(e({},x),(L={key:s,Policy:j},L["X-Amz-Signature"]=l(D),L))}]}})})},U=function(e){return e.toISOString().replace(/\.\d{3}Z$/,"Z")},$=function(e,t,n){var r=new e(t);return r.update(n),r.digest()};export{N as createPresignedPost};